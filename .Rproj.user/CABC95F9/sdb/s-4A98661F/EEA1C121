{
    "contents" : "q=function(u,p){\n\treturn(p*exp(u)/(1-p+p*exp(u)))\n}\nK=function(u,n,p){\n\treturn(sum(n*log(1-p+p*exp(u))))\n}\nKp=function(u,n,p){\n\treturn(sum(n*q(u,p)))\n}\nKpp=function(u,n,p){\n\tq_=q(u,p)\n\treturn(sum(n*q_*(1-q_)))\n}\nKppp=function(u,n,p){\n\tq_=q(u,p)\n\treturn(sum(n*q_*(1-q_)*(1-2*q_)))\n}\nKpppp=function(u,n,p){\n\tq_=q(u,p)\n\treturn(sum(n*q_*(1-q_)*(1-6*q_*(1-q_))))\n}\n\nsaddlepoint=function(u,n,p,s){\n\treturn(Kp(u,n,p)-s)\n}\n\npsinib=function(q,size,prob,lower.tail=TRUE,log.p=FALSE,method=c('Daniels','Butler')){\n\t\n\tmethod=match.arg(method)\n\t\n\tn=size\n\tp=prob\n\ts=q\n\t\n\tw=function(u,n,p){\n\t\tK_=K(u,n,p)\n\t\tKp_=Kp(u,n,p)\n\t\treturn(sign(u)*sqrt(2*u*Kp_-2*K_))\n\t}\n\tu1=function(u,n,p){\n\t\tKpp_=Kpp(u,n,p)\n\t\treturn((1-exp(-u))*sqrt(Kpp_))\n\t}\n\tp3=function(u,n,p){\n\t\tw_=w(u,n,p)\n\t\tu1_=u1(u,n,p)\n\t\tif (u1_==0) {\n\t\t\tKpp0=sum(n*p*(1-p))\n\t\t\tKppp0=sum(n*p*(1-p)*(1-2*p))\n\t\t\treturn(1/2-(2*pi)^(-1/2)*((1/6)*Kppp0*Kpp0^(-3/2)-(1/2)*Kpp0^(-1/2)))\n\t\t} else {\n\t\t\treturn(1-pnorm(w_)-dnorm(w_)*(1/w_-1/u1_))\n\t\t}\n\t}\n\t\n\t\n\tu2=function(u,n,p){\n\t\treturn(u*sqrt(Kpp(u,n,p)))\n\t}\n\tk3=function(u,n,p){\n\t\treturn(Kppp(u,n,p)*Kpp(u,n,p)^(-3/2))\n\t}\n\tk4=function(u,n,p){\n\t\treturn(Kpppp(u,n,p)*Kpp(u,n,p)^(-2))\n\t}\n\tp4=function(u,n,p){\n\t\tu2_=u2(u,n,p)\n\t\tk3_=k3(u,n,p)\n\t\tk4_=k4(u,n,p)\n\t\tw_=w(u,n,p)\n\t\tp3_=p3(u,n,p)\n\t\treturn(p3_-dnorm(w_)*((1/u2_)*((1/8)*k4_-(5/24)*k3_^2)-1/(u2_^3)-k3_/(2*u2_^2)+1/w_^3))\n\t}\n\tcalc_p4=function(s){\n\t\tif (s == sum(n)){\n\t\t\tp4_=prod(p^n)\n\t\t} else {\n\t\t\tu_hat=tryCatch({uniroot(saddlepoint,lower=-100,upper=100,tol = 0.0001,n=n,p=p,s=s)$root},error=function(e){return(NA)})\n\t\t\tif (is.na(u_hat)){\n\t\t\t\tn_trial=100000\n\t\t\t\tn_binom=length(p)\n\t\t\t\tset.seed(42)\n\t\t\t\tmat=matrix(rbinom(n_trial*n_binom,n,p),nrow=n_binom,ncol=n_trial)\n\t\t\t\tS=colSums(mat)\n\t\t\t\tp4_=sum(S>=s)/length(S)\n\t\t\t} else {\n\t\t\t\tp4_=p4(u_hat,n,p)\n\t\t\t}\n\t\t}\n\t\treturn(p4_)\n\t}\n\t\n\tif (method=='Daniels'){\n\t\tpsinib_=sapply(s,calc_p4)\n\t\tprint(psinib_)\n\t} else {\n\t\tdsinib_=dsinib(x=0:sum(size),size,prob)\n\t\tpsinib_=rep(0,length(dsinib_))\n\t\tfor (i in 1:length(dsinib_)){\n\t\t\tif (i==1){\n\t\t\t\tpsinib_[i]=dsinib_[i]\t\n\t\t\t} else {\n\t\t\t\tpsinib_[i]=dsinib_[i]+psinib_[i-1]\n\t\t\t}\n\t\t}\n\t}  \n\t\n\tif (lower.tail){\n\t\treturn(psinib_[s+1])\t\n\t} else {\n\t\treturn(1-psinib_[s+1])\n\t}\n}\n\ndsinib=function(x,size,prob,log=FALSE){\n\t\n\tn=size\n\tp=prob\n\ts=x\n\t\n\tp1=function(u,n,p,s){\n\t\treturn((2*pi*Kpp(u,n,p))^(-1/2)*exp(K(u,n,p)-u*s))\n\t}\n\tp2=function(u,n,p,s){\n\t\treturn(p1(u,n,p,s)*(1+(1/8)*Kpppp(u,n,p)/Kpp(u,n,p)^2-(5/24)*Kppp(u,n,p)^2/Kpp(u,n,p)^3))\n\t}\n\t\n\tcalc_p2=function(s){\n\t\tu_hat=tryCatch({uniroot(saddlepoint,lower=-100,upper=100,tol = 0.0001,n=n,p=p,s=s)$root},error=function(e){return(NA)})\n\t\tp2_=p2(u_hat,n,p,s)\n\t\treturn(p2_)\n\t}\n\tp2_=sapply(1:(sum(n)-1),calc_p2)\n\t\n\tp2b=function(n,p,p2_){\n\t\tp0=prod((1-p)^n)\n\t\tpmx=prod(p^n)\n\t\tp2b_=rep(NA,sum(n)+1)\n\t\tp2b_[1]=p0\n\t\tp2b_[length(p2b_)]=pmx\n\t\tp2b_[2:sum(n)]=(1-p0-pmx)*p2_/sum(p2_)\n\t\treturn(p2b_)\n\t}\n\tp2b_=p2b(n,p,p2_)\n\t\n\treturn(p2b_[s+1])\t\n}\n\n\nsize=n\nprob=p\nrsinib=function(n,size,prob){\n\tpsinib(q = 0,size = size,prob = prob)\n}\n\n",
    "created" : 1494120097122.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "0|16|2|0|\n3|18|5|0|\n6|19|8|0|\n9|20|12|0|\n13|21|16|0|\n17|22|20|0|\n22|30|24|0|\n34|19|38|1|\n39|20|42|1|\n43|20|53|1|\n56|20|58|1|\n59|20|61|1|\n62|20|64|1|\n65|20|72|1|\n73|21|90|1|\n",
    "hash" : "3421750555",
    "id" : "EEA1C121",
    "lastKnownWriteTime" : 1494182513,
    "path" : "~/Documents/tools/sinib/R/sinib.R",
    "project_path" : "R/sinib.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}